<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Russia 30 Speedrun</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html,body{height:100%;margin:0;font-family:'Inter', 'Segoe UI', sans-serif;background:#f8fafc;color:#0f172a;overflow:hidden;}
    #map{height:100vh;width:100vw;z-index: 1;}

    /* Stats Bar */
    .info-bar{position:absolute;top:20px;right:20px;background:rgba(15, 23, 42, 0.88);padding:15px;border-radius:12px;display:flex;flex-direction:column;gap:10px;z-index:900;backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.1);color:#fff;box-shadow:0 4px 20px rgba(0,0,0,0.2);}
    .info-item{display:flex;justify-content:space-between;align-items:center;min-width:140px; gap: 20px;}
    .info-label{font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;opacity:0.7;}
    .info-value{font-size:1.15rem;font-weight:800;font-variant-numeric: tabular-nums;}
    .status-alive{color:#4ade80;} .status-dead{color:#f87171;}

    /* Conveyor Belt System */
    .conveyor-viewport {
      position: absolute;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      height: 140px;
      z-index: 1001;
      overflow: hidden;
      pointer-events: none;
    }
    .conveyor-belt {
      display: flex;
      align-items: center;
      position: absolute;
      left: 50%;
      transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
      will-change: transform;
      height: 100%;
    }
    .city-card {
      min-width: 400px; /* 俄羅斯地名較長，寬度稍微拉大 */
      text-align: center;
      transition: all 0.5s ease;
      opacity: 0.5;
      transform: scale(0.8);
      font-size: 1.6rem;
      font-weight: 700;
      color: #475569;
    }
    .city-card.active {
      opacity: 1;
      transform: scale(1.1);
      color: #0f172a;
    }
    .active-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 420px;
      height: 80px;
      border: 4px solid #0f172a;
      background: rgba(255,255,255,0.3);
      border-radius: 16px;
      z-index: 1002;
    }

    .overlay{position:fixed;inset:0;background:rgba(15,23,42,0.9);display:flex;align-items:center;justify-content:center;z-index:2000;backdrop-filter:blur(10px);}
    .box{background:#fff;color:#1e293b;padding:40px;border-radius:24px;text-align:center;max-width:400px;}
    .btn{background:#0f172a;color:#fff;border:none;padding:15px 35px;border-radius:10px;font-weight:700;cursor:pointer;font-size:1.1rem;width:100%;margin-top:20px;transition:0.2s;}
    .btn:hover{background:#334155;}
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="info-bar">
    <div class="info-item"><span class="info-label">Time</span><span id="time" class="info-value">00:00</span></div>
    <div class="info-item"><span class="info-label">Progress</span><span class="info-value"><span id="progress">0</span>/30</span></div>
    <div class="info-item"><span class="info-label">Score</span><span id="score" class="info-value">0</span></div>
    <div class="info-item" id="statusBox" style="display:none;"><span class="info-label">Status</span><span id="aliveStatus" class="info-value status-alive">ALIVE</span></div>
  </div>

  <div class="conveyor-viewport">
    <div class="active-frame"></div>
    <div class="conveyor-belt" id="belt"></div>
  </div>

  <div id="overlayStart" class="overlay">
    <div class="box">
      <h1 style="margin-top:0">Russia Speedrun</h1>
      <p>Locate 30 major Russian cities.<br>Survival limit: <b>100km</b></p>
      <button id="startBtn" class="btn">Start Mission</button>
    </div>
  </div>

  <div id="endModal" style="display:none" class="overlay">
    <div class="box">
      <h2 id="resTitle">Run Finished</h2>
      <div id="stats" style="margin:15px 0;line-height:1.6"></div>
      <button onclick="location.reload()" class="btn">New Attempt</button>
    </div>
  </div>

  <script>
    const CITIES = [
      {name:"Moscow",coords:[55.7558,37.6173]},
      {name:"Saint Petersburg",coords:[59.9343,30.3351]},
      {name:"Novosibirsk",coords:[55.0084,82.9357]},
      {name:"Yekaterinburg",coords:[56.8389,60.6057]},
      {name:"Kazan",coords:[55.7887,49.1221]},
      {name:"Nizhny Novgorod",coords:[56.3269,44.0059]},
      {name:"Chelyabinsk",coords:[55.1644,61.4368]},
      {name:"Samara",coords:[53.2029,50.1508]},
      {name:"Omsk",coords:[54.9885,73.3242]},
      {name:"Rostov-on-Don",coords:[47.2357,39.7015]},
      {name:"Ufa",coords:[54.7388,55.9721]},
      {name:"Krasnoyarsk",coords:[56.0153,92.8932]},
      {name:"Voronezh",coords:[51.6608,39.2003]},
      {name:"Perm",coords:[58.0105,56.2502]},
      {name:"Volgograd",coords:[48.708,44.5133]},
      {name:"Krasnodar",coords:[45.0393,38.9872]},
      {name:"Saratov",coords:[51.5336,46.0342]},
      {name:"Tyumen",coords:[57.1522,65.5272]},
      {name:"Murmansk",coords:[68.9585,33.0827]},
      {name:"Izhevsk",coords:[56.8498,53.2045]},
      {name:"Yakutsk",coords:[62.0355,129.6755]},
      {name:"Irkutsk",coords:[52.287,104.305]},
      {name:"Yuzhno-Sakhalinsk",coords:[46.959,142.738]},
      {name:"Khabarovsk",coords:[48.4726,135.0577]},
      {name:"Vladivostok",coords:[43.1198,131.8869]},
      {name:"Yaroslavl",coords:[57.6261,39.8845]},
      {name:"Orenburg",coords:[51.7666,55.0988]},
      {name:"Tomsk",coords:[56.4977,84.9744]},
      {name:"Petropavlovsk-Kamchatskiy",coords:[53.0240,158.6436]},
      {name:"Astrakhan",coords:[46.3476,48.0302]}
    ].sort(()=>Math.random()-0.5);

    let idx=0, score=0, startTime, timer, started=false, answered=false, markers=[], circles=[], gameOver=false, deathCity="";
    const map = L.map('map',{zoomControl:false, attributionControl: false}).setView([60, 95], 3);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png').addTo(map);

    const belt = document.getElementById('belt');
    CITIES.forEach((c, i) => {
      const el = document.createElement('div');
      el.className = 'city-card';
      el.textContent = c.name;
      belt.appendChild(el);
    });

    function haversine(a,b){const R=6371;const dLat=(b[0]-a[0])*Math.PI/180,dLon=(b[1]-a[1])*Math.PI/180;const aa=Math.sin(dLat/2)**2+Math.cos(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa));}

    document.getElementById('startBtn').onclick=()=>{
      document.getElementById('overlayStart').style.display='none';
      document.getElementById('statusBox').style.display='flex';
      started=true; startTime=Date.now();
      timer=setInterval(()=>{
        const d=Date.now()-startTime;
        document.getElementById('time').textContent=`${String(Math.floor(d/60000)).padStart(2,'0')}:${String(Math.floor((d%60000)/1000)).padStart(2,'0')}`;
      },1000);
      updateConveyor();
    };

    function updateConveyor() {
      const offset = -(idx * 400) - 200;
      belt.style.transform = `translateX(${offset}px)`;
      const cards = document.querySelectorAll('.city-card');
      cards.forEach((card, i) => {
        card.classList.remove('active');
        if(i === idx) card.classList.add('active');
      });
      document.getElementById('progress').textContent = idx + 1;
    }

    map.on('click', e=>{
      if(!started||answered)return; answered=true;
      const city=CITIES[idx], dist=haversine([e.latlng.lat,e.latlng.lng], city.coords);
      
      const clickMarker = L.circleMarker([e.latlng.lat,e.latlng.lng],{radius:6,color:'#3b82f6',fillOpacity:0.8, weight:2}).addTo(map);
      const targetCircle = L.circle(city.coords,{radius:100000,color:'#22c55e',weight:2,fillOpacity:0.15}).addTo(map);
      const targetMarker = L.marker(city.coords).addTo(map).bindPopup(`<b>${city.name}</b><br>${dist.toFixed(1)} km`).openPopup();
      
      markers.push(clickMarker, targetMarker);
      circles.push(targetCircle);

      if(dist<=100){
        score += Math.max(10, Math.round(100 - dist));
        document.getElementById('score').textContent = score;
      } else if(!gameOver){
        gameOver = true; deathCity = city.name;
        const s = document.getElementById('aliveStatus');
        s.textContent = "OUT"; s.className = "info-value status-dead";
      }
      
      map.flyTo(city.coords, 5, {duration: 0.5}); // 俄羅斯很大，縮放到 5 比較合適
      
      setTimeout(()=>{
        markers.forEach(x=>map.removeLayer(x)); markers=[];
        circles.forEach(x=>map.removeLayer(x)); circles=[];
        idx++;
        if(idx < CITIES.length) {
          updateConveyor();
          answered = false;
          map.flyTo([60, 95], 3, {duration: 0.6});
        } else end();
      }, 1500);
    });

    function end(){
      clearInterval(timer);
      document.getElementById('resTitle').textContent = gameOver ? "Run Failed" : "Russia Master";
      document.getElementById('stats').innerHTML = `Final Score: <b>${score}</b><br>Progress: <b>${idx}/30</b><br>Time: <b>${document.getElementById('time').textContent}</b>${gameOver?`<br><br>Eliminated at: <span style="color:#ef4444">${deathCity}</span>`:""}`;
      document.getElementById('endModal').style.display='flex';
    }
  </script>
</body>
</html>
