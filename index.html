<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Russia Speedrun</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html,body{height:100%;margin:0;font-family:sans-serif;background:#0f1724;color:#e6eef8;overflow:hidden;}
    #map{height:100vh;width:100vw;}
    .overlay-start{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,0.95);z-index:1000;}
    .start-box{background:#fff;color:#04263b;padding:30px;border-radius:20px;text-align:center;width:320px;}
    .info-bar{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:10px 20px;border-radius:10px;display:flex;gap:20px;z-index:900;}
    .city-title{position:absolute;top:100px;left:50%;transform:translateX(-50%);z-index:1001;font-size:2rem;font-weight:900;text-shadow:2px 2px 5px #000;}
    .btn{background:#e11d48;color:#fff;border:none;padding:12px;border-radius:10px;font-weight:bold;cursor:pointer;width:100%;margin-top:10px;}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:2000;}
    .modal{background:#fff;color:#000;padding:30px;border-radius:20px;text-align:center;width:280px;}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info-bar">
    <div id="time">00:00</div>
    <div>Score: <span id="score">0</span></div>
    <div id="statusBox" style="color:#22c55e;font-weight:bold;display:none">ALIVE</div>
  </div>
  <div id="overlayStart" class="overlay-start">
    <div class="start-box">
      <h2 style="margin-top:0">Russia Run</h2>
      <p>Rules: 100km margin.</p>
      <p>Miss = OUT</p>
      <button id="startBtn" class="btn">START</button>
    </div>
  </div>
  <div id="cityTitle" class="city-title" style="display:none"></div>
  <div id="endModal" class="modal-backdrop" style="display:none">
    <div class="modal">
      <h2 id="resultTitle">Finish</h2>
      <div id="stats" style="margin:15px 0"></div>
      <button onclick="location.reload()" class="btn">Try Again</button>
    </div>
  </div>

  <script>
    // 確保這裡的變數名稱與下面 startGame 呼叫的一致
    const CITIES = [
      {name:"Moscow (Москва)",coords:[55.7558,37.6173]},{name:"Saint Petersburg (Санкт-Петербург)",coords:[59.9343,30.3351]},{name:"Novosibirsk (Новосибирск)",coords:[55.0084,82.9357]},{name:"Yekaterinburg (Екатерин堡)",coords:[56.8389,60.6057]},{name:"Kazan (喀山)",coords:[55.7887,49.1221]},{name:"Nizhny Novgorod (下諾夫哥羅德)",coords:[56.3269,44.0059]},{name:"Chelyabinsk (車里雅賓斯克)",coords:[55.1644,61.4368]},{name:"Samara (薩馬拉)",coords:[53.2029,50.1508]},{name:"Omsk (鄂木斯克)",coords:[54.9885,73.3242]},{name:"Rostov-on-Don (頓河畔羅斯托夫)",coords:[47.2357,39.7015]},{name:"Ufa (烏法)",coords:[54.7388,55.9721]},{name:"Krasnoyarsk (克拉斯諾亞爾斯克)",coords:[56.0153,92.8932]},{name:"Voronezh (沃羅涅日)",coords:[51.6608,39.2003]},{name:"Perm (彼爾姆)",coords:[58.0105,56.2502]},{name:"Volgograd (伏爾加格勒)",coords:[48.708,44.5133]},{name:"Krasnodar (克拉斯諾達爾)",coords:[45.0393,38.9872]},{name:"Saratov (薩拉托夫)",coords:[51.5336,46.0342]},{name:"Tyumen (秋明)",coords:[57.1522,65.5272]},{name:"Tolyatti (托里亞蒂)",coords:[53.5078,49.4192]},{name:"Izhevsk (伊熱夫斯克)",coords:[56.8498,53.2045]},{name:"Barnaul (巴爾瑙爾)",coords:[53.3497,83.7673]},{name:"Irkutsk (伊爾庫茨克)",coords:[52.287,104.305]},{name:"Ulyanovsk (烏里揚諾夫斯克)",coords:[54.3142,48.4031]},{name:"Khabarovsk (哈巴羅夫斯克)",coords:[48.4726,135.0577]},{name:"Vladivostok (海參崴)",coords:[43.1198,131.8869]},{name:"Yaroslavl (雅羅斯拉夫爾)",coords:[57.6261,39.8845]},{name:"Orenburg (奧倫堡)",coords:[51.7666,55.0988]},{name:"Tomsk (托木斯克)",coords:[56.4977,84.9744]},{name:"Kemerovo (克麥羅沃)",coords:[55.351,86.0871]},{name:"Astrakhan (阿斯特拉罕)",coords:[46.3476,48.0302]}
    ];

    let gameCities=[], index=0, score=0, startTime, timer, answered=false, isOut=false;
    let markers=[], circles=[], currentTargetMarker;

    const map = L.map('map', {zoomControl:false}).setView([60, 95], 3);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png').addTo(map);

    function haversine(a, b) {
      const R = 6371;
      const dLat = (b[0] - a[0]) * Math.PI / 180;
      const dLon = (b[1] - a[1]) * Math.PI / 180;
      const aa = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(a[0] * Math.PI / 180) * Math.cos(b[0] * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
      return R * 2 * Math.atan2(Math.sqrt(aa), Math.sqrt(1 - aa));
    }

    function showNext() {
      if(index >= 30) return end();
      answered = false;
      document.getElementById('cityTitle').textContent = gameCities[index].name;
      document.getElementById('cityTitle').style.display = 'block';
      map.flyTo([60, 95], 3);
    }

    map.on('click', (e) => {
      if(!startTime || answered || index >= 30) return;
      answered = true;
      const city = gameCities[index];
      const dist = haversine([e.latlng.lat, e.latlng.lng], city.coords);
      
      L.circleMarker(e.latlng, {radius:6, color:'#3b82f6'}).addTo(map);
      L.circle(city.coords, {radius:100000, color:'#22c55e', weight:2, fillOpacity:0.1}).addTo(map);
      currentTargetMarker = L.marker(city.coords).addTo(map).bindPopup(city.name + "<br>" + dist.toFixed(0) + "km").openPopup();

      if(dist <= 100) {
        score += Math.max(10, Math.round(100 - dist/2));
        document.getElementById('score').textContent = score;
      } else if (!isOut) {
        isOut = true;
        document.getElementById('statusBox').textContent = "OUT";
        document.getElementById('statusBox').style.color = "#ef4444";
      }

      map.flyTo(city.coords, 5);
      setTimeout(() => {
        map.removeLayer(currentTargetMarker);
        index++;
        showNext();
      }, 1500);
    });

    function end() {
      clearInterval(timer);
      document.getElementById('cityTitle').style.display = 'none';
      document.getElementById('resultTitle').textContent = isOut ? "Game Over" : "Clear!";
      document.getElementById('stats').innerHTML = "Score: " + score + "<br>Time: " + document.getElementById('time').textContent;
      document.getElementById('endModal').style.display = 'flex';
    }

    document.getElementById('startBtn').onclick = () => {
      document.getElementById('overlayStart').style.display = 'none';
      document.getElementById('statusBox').style.display = 'block';
      gameCities = [...CITIES].sort(() => Math.random() - 0.5);
      startTime = Date.now();
      timer = setInterval(() => {
        const s = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('time').textContent = Math.floor(s/60).toString().padStart(2,'0') + ":" + (s%60).toString().padStart(2,'0');
      }, 1000);
      showNext();
    };
  </script>
</body>
</html>
